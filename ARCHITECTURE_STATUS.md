# Modo AI CRUD æ¶æ„å®Œæ•´æ€§æŠ¥å‘Š

**ç”Ÿæˆæ—¶é—´**: 2024-11-17  
**ç›®çš„**: ç¡®ä¿ç”Ÿäº§ç¯å¢ƒçš„å®Œæ•´æ€§å’Œå®‰å…¨æ€§

---

## ğŸ“Š å½“å‰æ¶æ„æ¦‚è§ˆ

### æ¶æ„åˆ†å±‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              iOS App (å®¢æˆ·ç«¯)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  UI Layer                                            â”‚
â”‚  - TaskListView                                      â”‚
â”‚  - InsightPage (AI Chat)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AI Services Layer                                   â”‚
â”‚  âœ… ModoCoachService (AI å¯¹è¯å…¥å£)                   â”‚
â”‚  âœ… FirebaseAIService (è°ƒç”¨ Cloud Function)          â”‚
â”‚  âœ… AIFunctionCallCoordinator (å‡½æ•°è·¯ç”±)             â”‚
â”‚  âœ… AIPromptBuilder (Prompt æ„å»º)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Function Handlers (CRUD æ“ä½œ)                       â”‚
â”‚  âœ… QueryTasksHandler   - æŸ¥è¯¢ä»»åŠ¡                  â”‚
â”‚  âœ… CreateTasksHandler  - åˆ›å»ºä»»åŠ¡                  â”‚
â”‚  âœ… UpdateTaskHandler   - æ›´æ–°ä»»åŠ¡                  â”‚
â”‚  âœ… DeleteTaskHandler   - åˆ é™¤ä»»åŠ¡                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Business Logic Layer                                â”‚
â”‚  âœ… TaskManagerService (ä»»åŠ¡ç®¡ç†)                    â”‚
â”‚  âœ… TaskCacheService (æœ¬åœ°ç¼“å­˜)                      â”‚
â”‚  âœ… TaskListenerService (å®æ—¶ç›‘å¬)                   â”‚
â”‚  âœ… NotificationTaskService (é€šçŸ¥)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Data Access Layer                                   â”‚
â”‚  âœ… DatabaseService (Firebase RTDB æ“ä½œ)             â”‚
â”‚  âœ… TaskRepository (SwiftData æœ¬åœ°å­˜å‚¨)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Firebase Backend                                    â”‚
â”‚  âœ… Realtime Database (æ•°æ®å­˜å‚¨)                     â”‚
â”‚  âœ… Cloud Functions                                  â”‚
â”‚     - chatWithAI (AI å¯¹è¯)                          â”‚
â”‚     - deleteAccount (è´¦æˆ·åˆ é™¤)                       â”‚
â”‚  âœ… Authentication (ç”¨æˆ·è®¤è¯)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ… å·²å®ç°åŠŸèƒ½æ¸…å•

### 1. AI å¯¹è¯ç³»ç»Ÿ
- âœ… **ModoCoachService**: ä¸»è¦ AI æœåŠ¡ï¼Œå¤„ç†å¯¹è¯å’Œå‡½æ•°è°ƒç”¨
- âœ… **FirebaseAIService**: é€šè¿‡ Cloud Function è°ƒç”¨ OpenAI API
- âœ… **AIPromptBuilder**: System prompt åŒ…å«æ—¥æœŸä¸Šä¸‹æ–‡å’Œ CRUD æŒ‡å—
- âœ… **æ™ºèƒ½è·¯ç”±**: è‡ªåŠ¨åŒºåˆ†æ–° CRUD å‡½æ•°å’Œæ—§ legacy å‡½æ•°

### 2. CRUD Handlers (æ–°æ¶æ„)
| Handler | åŠŸèƒ½ | çŠ¶æ€ | é›†æˆ |
|---------|------|------|------|
| QueryTasksHandler | æŸ¥è¯¢ä»»åŠ¡ | âœ… | âœ… |
| CreateTasksHandler | åˆ›å»ºä»»åŠ¡ | âœ… | âœ… |
| UpdateTaskHandler | æ›´æ–°ä»»åŠ¡ | âœ… | âœ… |
| DeleteTaskHandler | åˆ é™¤ä»»åŠ¡ | âœ… | âœ… |

### 3. æ•°æ®æ“ä½œå±‚ (DatabaseService)
```swift
// âœ… ä¿ç•™æ‰€æœ‰åŸæœ‰æ–¹æ³•
func saveTask(userId: String, task: TaskItem, date: Date, completion)
  - åŒ…å«é‡å¤æ“ä½œæ£€æµ‹ (pendingOperations)
  - å®Œæ•´é”™è¯¯å¤„ç†
  - æ—¥å¿—è®°å½•

func deleteTask(userId: String, taskId: UUID, date: Date, completion)
  - å®‰å…¨åˆ é™¤
  - é”™è¯¯å¤„ç†

func fetchTasksForDate(userId: String, date: Date, completion)
  - å•æ¬¡æŸ¥è¯¢
  - è§£æå’ŒéªŒè¯

func listenToTasks(userId: String, date: Date, callback)
  - å®æ—¶ç›‘å¬
  - è‡ªåŠ¨æ›´æ–°
```

### 4. ä¸šåŠ¡é€»è¾‘å±‚ (TaskManagerService)
```swift
// âœ… ä¿ç•™æ‰€æœ‰åŸæœ‰æ–¹æ³•
func addTask(_ task: TaskItem, userId: String, onComplete)
  - ç¼“å­˜ + Firebase åŒå†™
  - å†²çªæ£€æµ‹
  - å®Œæ•´æ€§éªŒè¯

func removeTask(_ task: TaskItem, userId: String, onComplete)
  - ç¼“å­˜ + Firebase åŒåˆ 
  - æ¸…ç†å…³è”æ•°æ®

func updateTask(_ newTask: TaskItem, oldTask: TaskItem, userId: String, onComplete)
  - å¤„ç†æ—¥æœŸå˜æ›´
  - ç¼“å­˜åŒæ­¥
  - Firebase æ›´æ–°
```

### 5. ç¼“å­˜ç³»ç»Ÿ (TaskCacheService)
- âœ… æœ¬åœ°ç¼“å­˜ç®¡ç†
- âœ… ç¼“å­˜çª—å£æœºåˆ¶ (2ä¸ªæœˆ)
- âœ… è‡ªåŠ¨æ¸…ç†è¿‡æœŸæ•°æ®
- âœ… çº¿ç¨‹å®‰å…¨ (@MainActor)

### 6. å®æ—¶åŒæ­¥ (TaskListenerService)
- âœ… Firebase Realtime Database ç›‘å¬
- âœ… é˜²æŠ–æœºåˆ¶ (100ms)
- âœ… é™ˆæ—§æ•°æ®è¿‡æ»¤
- âœ… è‡ªåŠ¨ç¼“å­˜æ›´æ–°

### 7. é€šçŸ¥ç³»ç»Ÿ
- âœ… **AINotificationManager**: ç±»å‹å®‰å…¨çš„é€šçŸ¥æœºåˆ¶
- âœ… **NotificationTaskService**: ä»»åŠ¡ç›¸å…³é€šçŸ¥
- âœ… **NotificationSetupService**: é€šçŸ¥è®¾ç½®

---

## ğŸ”’ å®‰å…¨æ€§æ£€æŸ¥

### æ•°æ®è®¿é—®æ§åˆ¶
| å±‚çº§ | æ£€æŸ¥ | çŠ¶æ€ |
|------|------|------|
| Firebase Auth | ç”¨æˆ·è®¤è¯ | âœ… |
| Database Rules | æ•°æ®åº“è®¿é—®è§„åˆ™ | âš ï¸ éœ€è¦æ£€æŸ¥ |
| Handler Auth Check | Handler ä¸­éªŒè¯ userId | âœ… |
| API Key Security | Cloud Function ä¸­ä¿æŠ¤ | âœ… |

### æ•°æ®å®Œæ•´æ€§
- âœ… **é‡å¤æ“ä½œæ£€æµ‹**: DatabaseService.pendingOperations
- âœ… **æ•°æ®éªŒè¯**: taskToDictionary è½¬æ¢æ—¶éªŒè¯
- âœ… **é”™è¯¯æ¢å¤**: æ‰€æœ‰æ“ä½œéƒ½æœ‰é”™è¯¯å¤„ç†å’Œå›è°ƒ
- âœ… **äº‹åŠ¡å®‰å…¨**: Firebase setValue åŸå­æ“ä½œ

### å¹¶å‘æ§åˆ¶
- âœ… **æ“ä½œé˜Ÿåˆ—**: operationsQueue é˜²æ­¢ç«æ€æ¡ä»¶
- âœ… **ä¸»çº¿ç¨‹å®‰å…¨**: @MainActor æ ‡è®°
- âœ… **å¼‚æ­¥å¤„ç†**: async/await + withCheckedContinuation

---

## âš ï¸ å¾…å®Œå–„é¡¹ç›®

### 1. Firebase Database Rules
**å½“å‰çŠ¶æ€**: éœ€è¦æ£€æŸ¥ `database.rules.json`

**æ¨èè§„åˆ™**:
```json
{
  "rules": {
    "users": {
      "$uid": {
        ".read": "$uid === auth.uid",
        ".write": "$uid === auth.uid",
        "tasks": {
          "$date": {
            "$taskId": {
              ".validate": "newData.hasChildren(['id', 'title', 'time', 'category'])"
            }
          }
        }
      }
    }
  }
}
```

### 2. é”™è¯¯æ—¥å¿—å’Œç›‘æ§
- âš ï¸ **ç”Ÿäº§ç¯å¢ƒæ—¥å¿—**: è€ƒè™‘æ·»åŠ  Firebase Crashlytics
- âš ï¸ **æ€§èƒ½ç›‘æ§**: è€ƒè™‘æ·»åŠ  Firebase Performance Monitoring
- âš ï¸ **ç”¨æˆ·åé¦ˆ**: é”™è¯¯ä¸ŠæŠ¥æœºåˆ¶

### 3. æ•°æ®å¤‡ä»½å’Œæ¢å¤
- âš ï¸ **å®šæœŸå¤‡ä»½**: Firebase RTDB è‡ªåŠ¨å¤‡ä»½ç­–ç•¥
- âš ï¸ **æ•°æ®å¯¼å‡º**: ç”¨æˆ·æ•°æ®å¯¼å‡ºåŠŸèƒ½ (å·²æœ‰ PDFExportService)
- âš ï¸ **ç¾éš¾æ¢å¤**: æ•°æ®æ¢å¤æµç¨‹

### 4. æ€§èƒ½ä¼˜åŒ–
- âš ï¸ **ç¼“å­˜ç­–ç•¥**: å½“å‰ç¼“å­˜çª—å£ 2ä¸ªæœˆï¼Œå¯èƒ½éœ€è¦è°ƒæ•´
- âš ï¸ **æ‰¹é‡æ“ä½œ**: è€ƒè™‘æ·»åŠ æ‰¹é‡åˆ›å»º/æ›´æ–°/åˆ é™¤
- âš ï¸ **æ‡’åŠ è½½**: å¤§é‡ä»»åŠ¡æ—¶çš„åˆ†é¡µåŠ è½½

### 5. æµ‹è¯•è¦†ç›–
| ç»„ä»¶ | å•å…ƒæµ‹è¯• | é›†æˆæµ‹è¯• | çŠ¶æ€ |
|------|---------|---------|------|
| AIServiceUtils | âœ… | - | å®Œæˆ |
| AITaskDTO | âœ… | âœ… | å®Œæˆ |
| AINotificationManager | - | âœ… | éƒ¨åˆ† |
| Handlers | âš ï¸ | âš ï¸ | éœ€è¦å¢åŠ  |
| DatabaseService | âš ï¸ | âš ï¸ | éœ€è¦å¢åŠ  |
| TaskManagerService | âš ï¸ | âš ï¸ | éœ€è¦å¢åŠ  |

---

## ğŸ¯ ç”Ÿäº§ç¯å¢ƒå°±ç»ªæ¸…å•

### å¿…é¡»å®Œæˆ
- [ ] æ£€æŸ¥å¹¶æ›´æ–° Firebase Database Rules
- [ ] æ·»åŠ é”™è¯¯æ—¥å¿—å’Œç›‘æ§
- [ ] å®Œå–„å•å…ƒæµ‹è¯•è¦†ç›–
- [ ] æ€§èƒ½æµ‹è¯•å’Œä¼˜åŒ–
- [ ] å®‰å…¨å®¡è®¡

### æ¨èå®Œæˆ
- [ ] æ·»åŠ  Crashlytics é›†æˆ
- [ ] å®ç°æ•°æ®å¤‡ä»½ç­–ç•¥
- [ ] ç”¨æˆ·æ“ä½œå®¡è®¡æ—¥å¿—
- [ ] A/B æµ‹è¯•æ¡†æ¶
- [ ] ç°åº¦å‘å¸ƒç­–ç•¥

### å¯é€‰ä¼˜åŒ–
- [ ] ç¦»çº¿æ¨¡å¼ä¼˜åŒ–
- [ ] æ•°æ®å‹ç¼©
- [ ] CDN åŠ é€Ÿ
- [ ] å¤šåŒºåŸŸéƒ¨ç½²

---

## ğŸ“ æ¶æ„å†³ç­–è®°å½• (ADR)

### ADR-001: ä¸ºä»€ä¹ˆ CRUD æ“ä½œåœ¨å®¢æˆ·ç«¯è€Œä¸æ˜¯ Cloud Functionsï¼Ÿ

**å†³ç­–**: ä½¿ç”¨ Firebase Realtime Database çš„å®¢æˆ·ç«¯ SDK ç›´æ¥æ“ä½œæ•°æ®ï¼Œè€Œä¸æ˜¯é€šè¿‡ Cloud Functions

**ç†ç”±**:
1. **å®æ—¶æ€§**: Firebase RTDB æä¾›å®æ—¶ç›‘å¬ï¼Œæ— éœ€è½®è¯¢
2. **æ€§èƒ½**: å‡å°‘ç½‘ç»œè·³è½¬ï¼Œé™ä½å»¶è¿Ÿ
3. **æˆæœ¬**: å‡å°‘ Cloud Function è°ƒç”¨æ¬¡æ•°
4. **ç¦»çº¿æ”¯æŒ**: Firebase SDK è‡ªå¸¦ç¦»çº¿ç¼“å­˜
5. **ç®€åŒ–**: å‡å°‘ä¸­é—´å±‚ï¼Œé™ä½å¤æ‚åº¦

**æƒè¡¡**:
- âœ… ä¼˜ç‚¹: å¿«é€Ÿã€å®æ—¶ã€æˆæœ¬ä½
- âš ï¸ æ³¨æ„: éœ€è¦ä¸¥æ ¼çš„ Database Rules ä¿æŠ¤

### ADR-002: ä¸ºä»€ä¹ˆä¿ç•™ Legacy Function Handlersï¼Ÿ

**å†³ç­–**: ä¿ç•™ generate_workout_plan ç­‰æ—§å‡½æ•°çš„å¤„ç†é€»è¾‘

**ç†ç”±**:
1. **ç”Ÿäº§å®‰å…¨**: é¿å…ç ´åç°æœ‰åŠŸèƒ½
2. **æ¸è¿›å¼é‡æ„**: é€æ­¥è¿ç§»è€Œéé‡å†™
3. **å‘åå…¼å®¹**: æ”¯æŒå·²æœ‰çš„ AI å¯¹è¯æµç¨‹
4. **é£é™©æ§åˆ¶**: æ–°æ—§æ¶æ„å¹¶å­˜ï¼Œé™ä½é£é™©

**è¿ç§»è®¡åˆ’**:
- Phase 1: æ–° CRUD ä½¿ç”¨ Handler æ¨¡å¼ âœ…
- Phase 2: è§‚å¯Ÿç¨³å®šæ€§å’Œæ€§èƒ½ â³
- Phase 3: è€ƒè™‘è¿ç§» Legacy å‡½æ•° ğŸ”®

---

## ğŸš€ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³è¡ŒåŠ¨
1. âœ… å®Œæˆ CRUD Handlers å®ç°
2. âœ… é›†æˆåˆ° ModoCoachService
3. âœ… æ·»åŠ è¯¦ç»†æ—¥å¿—
4. â³ çœŸå®ç¯å¢ƒæµ‹è¯•

### çŸ­æœŸ (1-2å‘¨)
1. æ£€æŸ¥å¹¶æ›´æ–° Firebase Database Rules
2. å¢åŠ é”™è¯¯å¤„ç†æµ‹è¯•
3. æ€§èƒ½åŸºå‡†æµ‹è¯•
4. ç”¨æˆ·åé¦ˆæ”¶é›†

### ä¸­æœŸ (1ä¸ªæœˆ)
1. å®Œå–„æµ‹è¯•è¦†ç›–
2. æ·»åŠ ç›‘æ§å’Œå‘Šè­¦
3. ä¼˜åŒ–ç¼“å­˜ç­–ç•¥
4. æ–‡æ¡£å®Œå–„

---

**æ€»ç»“**: 
- âœ… æ ¸å¿ƒåŠŸèƒ½å®Œæ•´
- âœ… æ¶æ„æ¸…æ™°åˆç†
- âš ï¸ éœ€è¦å®Œå–„å®‰å…¨å’Œç›‘æ§
- ğŸ¯ å¯ä»¥å¼€å§‹çœŸå®ç¯å¢ƒæµ‹è¯•

